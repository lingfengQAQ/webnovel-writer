# æ•°æ®å½’æ¡£ç­–ç•¥ï¼ˆ200ä¸‡å­—é•¿è·‘ä¿éšœï¼‰

> **ç›®æ ‡**ï¼šé˜²æ­¢ state.json æ— é™å¢é•¿ï¼Œç¡®ä¿ 200 ä¸‡å­—å°è¯´åˆ›ä½œæµç¨‹ç¨³å®šè¿è¡Œã€‚

---

## é—®é¢˜èƒŒæ™¯

### Gemini 2M+ å‹åŠ›æµ‹è¯•å‘ç°çš„è‡´å‘½ç¼ºé™·

åœ¨ webnovel-writer ç³»ç»Ÿçš„å®¡æ ¸ä¸­ï¼ŒGemini æŒ‡å‡ºäº†ä¸€ä¸ªé•¿æœŸè¿è¡Œçš„æ½œåœ¨é£é™©ï¼š

**ç°è±¡**ï¼š
- `update_state.py` åªå¯¹ `strand_tracker.history` åšäº†å±€éƒ¨ä¿®å‰ªï¼ˆä¿ç•™æœ€è¿‘ 50 ç« ï¼‰
- ä½† `entities.characters`ï¼ˆè§’è‰²åº“ï¼‰å’Œ `plot_threads.resolved`ï¼ˆå·²å›æ”¶ä¼ç¬”ï¼‰ä¼šæ— é™è¿½åŠ 

**åæœæ¨æ¼”**ï¼ˆ200ä¸‡å­—åœºæ™¯ï¼‰ï¼š
1. **100 ä¸‡å­—æ—¶**ï¼šstate.json è¾¾åˆ° **5MB**
2. **update_state.py æ€§èƒ½ä¸‹é™**ï¼šæ¯æ¬¡è¯»å†™éƒ½è¦è§£æå’Œåºåˆ—åŒ– 5MB çš„ JSONï¼ŒIO å¼€é”€è¶Šæ¥è¶Šå¤§
3. **AI ä¸Šä¸‹æ–‡é£é™©**ï¼šå¦‚æœç”¨æˆ·è¯¯ç”¨ `cat .webnovel/state.json`ï¼Œä¼šå¯¼è‡´å¤§é‡ Token æ¶ˆè€—ï¼ˆ5MB â‰ˆ 150ä¸‡å­— â‰ˆ 30ä¸‡ Tokensï¼‰
4. **Git ä»“åº“è†¨èƒ€**ï¼šæ¯æ¬¡ commit éƒ½ä¼šä¿å­˜å®Œæ•´çš„ state.jsonï¼Œä»“åº“ä½“ç§¯å¿«é€Ÿå¢é•¿

**è™½ç„¶ context_manager.py èƒ½é€šè¿‡æ»‘åŠ¨çª—å£ç¼“è§£ AI è¯»å–å‹åŠ›ï¼Œä½† state.json æœ¬èº«çš„å¤§å°ä»ç„¶ä¼šä¸æ–­å¢é•¿ã€‚**

---

## è§£å†³æ–¹æ¡ˆï¼šæ™ºèƒ½å½’æ¡£ç³»ç»Ÿ

### è®¾è®¡åŸåˆ™

1. **æ¸è¿›å¼å½’æ¡£**ï¼ˆProgressive Archivingï¼‰
   - ä¸æ˜¯ä¸€æ¬¡æ€§æ¸…ç©ºï¼Œè€Œæ˜¯æ ¹æ®"æ´»è·ƒåº¦"é€æ­¥å½’æ¡£
   - ä¿ç•™è¿‘æœŸæ´»è·ƒçš„æ•°æ®ï¼Œå½’æ¡£é•¿æœŸä¸æ´»è·ƒçš„æ•°æ®

2. **è‡ªåŠ¨è§¦å‘**ï¼ˆAuto-Triggeredï¼‰
   - æ¯ 10 ç« æ£€æŸ¥ä¸€æ¬¡å½’æ¡£æ¡ä»¶
   - æ–‡ä»¶å¤§å°è¶…è¿‡ 1MB æ—¶è§¦å‘å¼ºåˆ¶å½’æ¡£

3. **å¯é€†æ€§**ï¼ˆReversibleï¼‰
   - æ‰€æœ‰å½’æ¡£æ•°æ®éƒ½ä¿å­˜åœ¨ `archive/` ç›®å½•
   - å¯ä»¥éšæ—¶æ¢å¤å½’æ¡£çš„è§’è‰²/ä¼ç¬”

4. **é€æ˜æ€§**ï¼ˆTransparentï¼‰
   - ç”¨æˆ·å¯ä»¥æŸ¥çœ‹å½’æ¡£ç»Ÿè®¡ (`--stats`)
   - å¯ä»¥é¢„è§ˆå³å°†å½’æ¡£çš„æ•°æ® (`--dry-run`)

---

## å½’æ¡£ç­–ç•¥è¯¦è§£

### 1. è§’è‰²å½’æ¡£ï¼ˆCharacter Archivingï¼‰

**è§¦å‘æ¡ä»¶**ï¼š
- è§’è‰² `importance="minor"`ï¼ˆæ¬¡è¦è§’è‰²ï¼‰
- **è¶…è¿‡ 50 ç« æœªå‡ºåœº**ï¼ˆ`current_chapter - last_appearance_chapter â‰¥ 50`ï¼‰

**å½’æ¡£ç›®æ ‡**ï¼š
- `.webnovel/.webnovel/archive/characters.json`

**ä¿ç•™æ•°æ®**ï¼š
- ä¸»è¦è§’è‰²ï¼ˆ`importance="major"`ï¼‰**æ°¸ä¸å½’æ¡£**
- å¥³ä¸»ã€å¸ˆçˆ¶ã€ä¸»è¦åæ´¾ç­‰å…³é”®è§’è‰²ä¿æŒæ´»è·ƒ

**æ¢å¤æœºåˆ¶**ï¼š
```bash
python archive_manager.py --restore-character "æé›ª"
```

**ç¤ºä¾‹**ï¼š
```
ç¬¬ 5 ç« ï¼šè§’è‰²"è·¯äººç”²"å‡ºåœºï¼ˆæ‰“è„¸å·¥å…·äººï¼‰
ç¬¬ 60 ç« ï¼šæ£€æµ‹åˆ°"è·¯äººç”²"è¶…è¿‡ 50 ç« æœªå‡ºåœº â†’ å½’æ¡£
ç¬¬ 120 ç« ï¼šå‰§æƒ…éœ€è¦"è·¯äººç”²"é‡æ–°å‡ºåœº â†’ ç”¨æˆ·æ‰§è¡Œæ¢å¤å‘½ä»¤
```

---

### 2. ä¼ç¬”å½’æ¡£ï¼ˆPlot Thread Archivingï¼‰

**è§¦å‘æ¡ä»¶**ï¼š
- ä¼ç¬” `status="å·²å›æ”¶"`
- **è¶…è¿‡ 20 ç« **ï¼ˆ`current_chapter - resolved_chapter â‰¥ 20`ï¼‰

**å½’æ¡£ç›®æ ‡**ï¼š
- `.webnovel/.webnovel/archive/plot_threads.json`

**ä¿ç•™æ•°æ®**ï¼š
- æœªå›æ”¶çš„ä¼ç¬”ï¼ˆ`status="æœªå›æ”¶"`ï¼‰**æ°¸ä¸å½’æ¡£**
- é•¿æœŸä¸»çº¿ä¼ç¬”ä¿æŒæ´»è·ƒ

**æ¢å¤æœºåˆ¶**ï¼š
- ä¼ç¬”å½’æ¡£åé€šå¸¸ä¸éœ€è¦æ¢å¤ï¼ˆå·²å®Œæˆå…¶ä½¿å‘½ï¼‰
- å¦‚éœ€æŸ¥é˜…å†å²ä¼ç¬”ï¼Œå¯ç›´æ¥è¯»å–å½’æ¡£æ–‡ä»¶

**ç¤ºä¾‹**ï¼š
```
ç¬¬ 10 ç« ï¼šåŸ‹ä¸‹ä¼ç¬”"ç¥ç§˜ç‰ä½©çš„ç§˜å¯†"
ç¬¬ 45 ç« ï¼šå›æ”¶ä¼ç¬”"ç¥ç§˜ç‰ä½©çš„ç§˜å¯†"ï¼ˆstatus="å·²å›æ”¶"ï¼‰
ç¬¬ 70 ç« ï¼šæ£€æµ‹åˆ°ä¼ç¬”å·²å›æ”¶è¶…è¿‡ 20 ç«  â†’ å½’æ¡£
```

---

### 3. å®¡æŸ¥æŠ¥å‘Šå½’æ¡£ï¼ˆReview Report Archivingï¼‰

**è§¦å‘æ¡ä»¶**ï¼š
- å®¡æŸ¥æŠ¥å‘Šè¶…è¿‡ **50 ç« **ï¼ˆ`current_chapter - review_chapter â‰¥ 50`ï¼‰

**å½’æ¡£ç›®æ ‡**ï¼š
- `.webnovel/.webnovel/archive/reviews.json`

**ä¿ç•™æ•°æ®**ï¼š
- æœ€è¿‘ 50 ç« çš„å®¡æŸ¥æŠ¥å‘Šä¿æŒæ´»è·ƒ
- ç”¨äºåˆ†æè´¨é‡è¶‹åŠ¿

**æ¢å¤æœºåˆ¶**ï¼š
- å®¡æŸ¥æŠ¥å‘Šå½’æ¡£åé€šå¸¸ä¸éœ€è¦æ¢å¤
- å¦‚éœ€æŸ¥é˜…å†å²æŠ¥å‘Šï¼Œå¯ç›´æ¥è¯»å–å½’æ¡£æ–‡ä»¶

**ç¤ºä¾‹**ï¼š
```
ç¬¬ 10 ç« ï¼šåŒç« å®¡æŸ¥ï¼ˆCh9-10ï¼‰
ç¬¬ 65 ç« ï¼šæ£€æµ‹åˆ° Ch9-10 å®¡æŸ¥æŠ¥å‘Šè¶…è¿‡ 50 ç«  â†’ å½’æ¡£
```

---

## è§¦å‘æ¡ä»¶è¯¦è§£

### è‡ªåŠ¨è§¦å‘ï¼ˆAuto-Checkï¼‰

åœ¨ `webnovel-write.md` çš„ **Step 4.5** ä¸­ï¼Œæ¯æ¬¡ç« èŠ‚åˆ›ä½œå®Œæˆåè‡ªåŠ¨è°ƒç”¨ï¼š

```bash
python archive_manager.py --auto-check
```

**è§¦å‘æ¡ä»¶**ï¼ˆæ»¡è¶³ä»»ä¸€å³æ‰§è¡Œå½’æ¡£ï¼‰ï¼š
1. **æ–‡ä»¶å¤§å°è§¦å‘**ï¼š`state.json` å¤§å° â‰¥ **1 MB**
2. **ç« èŠ‚è§¦å‘**ï¼šå½“å‰ç« èŠ‚æ•°æ˜¯ **10 çš„å€æ•°**ï¼ˆæ¯ 10 ç« æ£€æŸ¥ä¸€æ¬¡ï¼‰

**ç¤ºä¾‹è¾“å‡º**ï¼ˆæ— éœ€å½’æ¡£ï¼‰ï¼š
```
âœ… æ— éœ€å½’æ¡£ï¼ˆè§¦å‘æ¡ä»¶æœªæ»¡è¶³ï¼‰
   æ–‡ä»¶å¤§å°: 0.35 MB (é˜ˆå€¼: 1.0 MB)
   å½“å‰ç« èŠ‚: 7 (æ¯ 10 ç« è§¦å‘)
```

**ç¤ºä¾‹è¾“å‡º**ï¼ˆè§¦å‘å½’æ¡£ï¼‰ï¼š
```
ğŸ” å¼€å§‹å½’æ¡£æ£€æŸ¥...
   æ–‡ä»¶å¤§å°: 1.2 MB
   å½“å‰ç« èŠ‚: 120

ğŸ“Š å½’æ¡£ç»Ÿè®¡:
   ä¸æ´»è·ƒè§’è‰²: 12
   å·²å›æ”¶ä¼ç¬”: 8
   æ—§å®¡æŸ¥æŠ¥å‘Š: 5

âœ… å½’æ¡£å®Œæˆ:
   è§’è‰²å½’æ¡£: 12 â†’ characters.json
   ä¼ç¬”å½’æ¡£: 8 â†’ plot_threads.json
   æŠ¥å‘Šå½’æ¡£: 5 â†’ reviews.json

ğŸ’¾ æ–‡ä»¶å¤§å°: 1.2 MB â†’ 0.8 MB (èŠ‚çœ 0.4 MB)
```

---

### å¼ºåˆ¶å½’æ¡£ï¼ˆForceï¼‰

ç”¨æˆ·å¯ä»¥æ‰‹åŠ¨è§¦å‘å½’æ¡£ï¼Œå¿½ç•¥è§¦å‘æ¡ä»¶ï¼š

```bash
python archive_manager.py --force
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- æ‰‹åŠ¨æ¸…ç† state.json
- æ€§èƒ½ä¼˜åŒ–
- Git ä»“åº“ä½“ç§¯ä¼˜åŒ–

---

### Dry-Run æ¨¡å¼

é¢„è§ˆå³å°†å½’æ¡£çš„æ•°æ®ï¼Œä½†ä¸æ‰§è¡Œå®é™…å½’æ¡£ï¼š

```bash
python archive_manager.py --auto-check --dry-run
```

**ç¤ºä¾‹è¾“å‡º**ï¼š
```
ğŸ” [Dry-run] å°†è¢«å½’æ¡£çš„æ•°æ®:

   ä¸æ´»è·ƒè§’è‰²:
   - è·¯äººç”² (è¶…è¿‡ 55 ç« æœªå‡ºåœº)
   - æ‰“é…±æ²¹ä¹™ (è¶…è¿‡ 63 ç« æœªå‡ºåœº)
   - ...ï¼ˆå…± 12 ä¸ªï¼‰

   å·²å›æ”¶ä¼ç¬”:
   - ç¥ç§˜ç‰ä½©çš„ç§˜å¯† (å·²å›æ”¶ 25 ç« )
   - å¤©é›·æœçš„ä¸‹è½ (å·²å›æ”¶ 30 ç« )
   - ...ï¼ˆå…± 8 ä¸ªï¼‰

   æ—§å®¡æŸ¥æŠ¥å‘Š:
   - Ch9-10 (55 ç« å‰)
   - Ch19-20 (45 ç« å‰)
   - ...ï¼ˆå…± 5 ä¸ªï¼‰
```

---

## å½’æ¡£æ–‡ä»¶ç»“æ„

```
.webnovel/
â”œâ”€â”€ state.json               # æ´»è·ƒæ•°æ®ï¼ˆ1 MB ä»¥ä¸‹ï¼‰
â””â”€â”€ archive/                 # å½’æ¡£ç›®å½•
    â”œâ”€â”€ characters.json      # å½’æ¡£çš„è§’è‰²
    â”œâ”€â”€ plot_threads.json    # å½’æ¡£çš„ä¼ç¬”
    â””â”€â”€ reviews.json         # å½’æ¡£çš„å®¡æŸ¥æŠ¥å‘Š
```

**å½’æ¡£æ–‡ä»¶æ ¼å¼**ï¼ˆç¤ºä¾‹ï¼‰ï¼š

**.webnovel/archive/characters.json**:
```json
[
  {
    "name": "è·¯äººç”²",
    "importance": "minor",
    "description": "è¢«ä¸»è§’æ‰“è„¸çš„å·¥å…·äºº",
    "last_appearance_chapter": 5,
    "archived_at": "2025-01-02T12:30:45"
  },
  {
    "name": "æ‰“é…±æ²¹ä¹™",
    "importance": "minor",
    "description": "é™ªè¡¬è§’è‰²",
    "last_appearance_chapter": 8,
    "archived_at": "2025-01-02T12:30:45"
  }
]
```

**.webnovel/archive/plot_threads.json**:
```json
[
  {
    "description": "ç¥ç§˜ç‰ä½©çš„ç§˜å¯†",
    "status": "å·²å›æ”¶",
    "introduced_chapter": 10,
    "resolved_chapter": 45,
    "resolution": "ç‰ä½©æ˜¯ä¸»è§’çˆ¶äº²ç•™ä¸‹çš„ä¿¡ç‰©",
    "archived_at": "2025-01-02T12:30:45"
  }
]
```

---

## æ€§èƒ½é¢„æµ‹ï¼ˆ200ä¸‡å­—åœºæ™¯ï¼‰

### åœºæ™¯ 1ï¼šæ— å½’æ¡£ç³»ç»Ÿ

| ç« èŠ‚ | æ€»å­—æ•° | state.json å¤§å° | è¯»å†™è€—æ—¶ | é£é™© |
|------|--------|----------------|----------|------|
| 100 ç«  | 50 ä¸‡å­— | **1.5 MB** | 50 ms | âš ï¸ ä¸­ç­‰ |
| 200 ç«  | 100 ä¸‡å­— | **3.5 MB** | 150 ms | ğŸ”´ é«˜ |
| 400 ç«  | 200 ä¸‡å­— | **8 MB** | 500 ms | ğŸ”´ğŸ”´ æé«˜ |

**é—®é¢˜**ï¼š
- 200 ç« åï¼Œæ¯æ¬¡ `update_state.py` è€—æ—¶ 150ms+
- 400 ç« æ—¶ï¼Œstate.json è¾¾åˆ° 8MBï¼ŒGit ä»“åº“ä½“ç§¯å¤±æ§

---

### åœºæ™¯ 2ï¼šå¯ç”¨å½’æ¡£ç³»ç»Ÿ

| ç« èŠ‚ | æ€»å­—æ•° | state.json å¤§å° | å½’æ¡£æ–‡ä»¶å¤§å° | è¯»å†™è€—æ—¶ | é£é™© |
|------|--------|----------------|-------------|----------|------|
| 100 ç«  | 50 ä¸‡å­— | **0.8 MB** | 0.5 MB | 30 ms | âœ… ä½ |
| 200 ç«  | 100 ä¸‡å­— | **0.9 MB** | 1.8 MB | 35 ms | âœ… ä½ |
| 400 ç«  | 200 ä¸‡å­— | **1.0 MB** | 4.5 MB | 40 ms | âœ… ä½ |

**ä¼˜åŠ¿**ï¼š
- state.json ç¨³å®šåœ¨ **1 MB ä»¥ä¸‹**
- `update_state.py` è€—æ—¶ç¨³å®šåœ¨ **30-40 ms**
- å½’æ¡£æ–‡ä»¶å•ç‹¬ç®¡ç†ï¼Œä¸å½±å“ä¸»æµç¨‹æ€§èƒ½

**æ•°æ®å½’æ¡£è§„å¾‹**ï¼ˆæ¯ 10 ç« è§¦å‘ï¼‰ï¼š
- **Ch 10, 20, 30...**ï¼šæ£€æŸ¥å½’æ¡£æ¡ä»¶
- **Ch 60**ï¼šé¦–æ¬¡å½’æ¡£ï¼ˆ12 ä¸ªæ¬¡è¦è§’è‰²ï¼‰
- **Ch 100**ï¼šå½’æ¡£ 8 ä¸ªå·²å›æ”¶ä¼ç¬”
- **Ch 150**ï¼šå½’æ¡£ 5 ä¸ªæ—§å®¡æŸ¥æŠ¥å‘Š
- **Ch 200+**ï¼šç¨³å®šè¿è¡Œï¼Œstate.json ä¿æŒ 1 MB ä»¥ä¸‹

---

## æ¢å¤æœºåˆ¶

### æ¢å¤å½’æ¡£çš„è§’è‰²

```bash
python archive_manager.py --restore-character "æé›ª"
```

**æ‰§è¡Œé€»è¾‘**ï¼š
1. ä» `.webnovel/.webnovel/archive/characters.json` ä¸­æŸ¥æ‰¾è§’è‰²"æé›ª"
2. ç§»é™¤ `archived_at` å­—æ®µ
3. å°†è§’è‰²æ¢å¤åˆ° `state.json` çš„ `entities.characters`
4. ä»å½’æ¡£æ–‡ä»¶ä¸­ç§»é™¤è¯¥è§’è‰²

**ç¤ºä¾‹è¾“å‡º**ï¼š
```
âœ… è§’è‰²å·²æ¢å¤: æé›ª
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- å‰§æƒ…éœ€è¦æŸä¸ªæ¬¡è¦è§’è‰²é‡æ–°å‡ºåœº
- ç”¨æˆ·è¯¯å½’æ¡£äº†é‡è¦è§’è‰²ï¼ˆè™½ç„¶ä¸»è¦è§’è‰²ä¸ä¼šè¢«å½’æ¡£ï¼‰

---

## æŸ¥çœ‹å½’æ¡£ç»Ÿè®¡

```bash
python archive_manager.py --stats
```

**ç¤ºä¾‹è¾“å‡º**ï¼š
```
ğŸ“Š å½’æ¡£ç»Ÿè®¡:
   è§’è‰²å½’æ¡£: 24
   ä¼ç¬”å½’æ¡£: 15
   æŠ¥å‘Šå½’æ¡£: 8
   å½’æ¡£å¤§å°: 2.3 KB

ğŸ’¾ state.json å½“å‰å¤§å°: 0.9 MB
```

---

## é›†æˆåˆ°åˆ›ä½œæµç¨‹

### webnovel-write.md çš„é›†æˆç‚¹

åœ¨ **Step 4ï¼ˆUpdate Stateï¼‰** ä¹‹åï¼Œ**Step 5ï¼ˆGit Backupï¼‰** ä¹‹å‰ï¼š

```markdown
### Step 4.5: Data Archiving (AUTO-TRIGGERED)

**CRITICAL**: After Step 4, **automatically run** archive check:

```bash
python .claude/skills/webnovel-writer/scripts/archive_manager.py --auto-check
```

**Purpose**: é˜²æ­¢ state.json æ— é™å¢é•¿ï¼ˆ200ä¸‡å­—é•¿è·‘ä¿éšœï¼‰

**IMPORTANT**:
- **ä¸éœ€è¦ workflow_manager è¿½è¸ª**ï¼ˆå½’æ¡£æ˜¯å†…éƒ¨ç»´æŠ¤æ“ä½œï¼‰
- å¦‚æŠ¥é”™ï¼ˆå¦‚æ–‡ä»¶ä¸å­˜åœ¨ï¼‰ï¼Œè§†ä¸ºè­¦å‘Šï¼Œä¸é˜»å¡æµç¨‹
- å½’æ¡£æ•°æ®å¯éšæ—¶ä½¿ç”¨ `--restore-character "è§’è‰²å"` æ¢å¤
```

### Execution Checklist

æ–°å¢å½’æ¡£æ£€æŸ¥é¡¹ï¼š

```markdown
**Data Archiving** (200ä¸‡å­—é•¿è·‘ä¿éšœ):
- [ ] `archive_manager.py --auto-check` executed after Step 4
- [ ] Archive check result confirmed (æ— éœ€å½’æ¡£ OR å½’æ¡£å®Œæˆ)
```

---

## æŠ€æœ¯å®ç°ç»†èŠ‚

### archive_manager.py æ ¸å¿ƒç±»

```python
class ArchiveManager:
    def __init__(self, project_root=None):
        self.state_file = project_root / ".webnovel" / "state.json"
        self.archive_dir = project_root / ".webnovel" / "archive"

        # å½’æ¡£è§„åˆ™é…ç½®
        self.config = {
            "character_inactive_threshold": 50,  # è§’è‰²è¶…è¿‡ 50 ç« æœªå‡ºåœº
            "plot_resolved_threshold": 20,       # å·²å›æ”¶ä¼ç¬”è¶…è¿‡ 20 ç« 
            "review_old_threshold": 50,          # å®¡æŸ¥æŠ¥å‘Šè¶…è¿‡ 50 ç« 
            "file_size_trigger_mb": 1.0,         # æ–‡ä»¶å¤§å°è§¦å‘é˜ˆå€¼
            "chapter_trigger": 10                # æ¯ 10 ç« æ£€æŸ¥
        }
```

### æ ¸å¿ƒæ–¹æ³•

**1. check_trigger_conditions()**
- æ£€æŸ¥æ–‡ä»¶å¤§å°å’Œç« èŠ‚æ•°
- è¿”å›æ˜¯å¦éœ€è¦å½’æ¡£

**2. identify_inactive_characters()**
- éå† `entities.characters`
- ç­›é€‰å‡º `importance="minor"` ä¸”è¶…è¿‡ 50 ç« æœªå‡ºåœºçš„è§’è‰²

**3. identify_resolved_plot_threads()**
- éå† `plot_threads.resolved`
- ç­›é€‰å‡ºè¶…è¿‡ 20 ç« çš„å·²å›æ”¶ä¼ç¬”

**4. archive_characters() / archive_plot_threads() / archive_reviews()**
- å°†æ•°æ®å†™å…¥å½’æ¡£æ–‡ä»¶
- æ·»åŠ  `archived_at` æ—¶é—´æˆ³

**5. remove_from_state()**
- ä» `state.json` ä¸­ç§»é™¤å·²å½’æ¡£çš„æ•°æ®
- åŸå­æ€§æ“ä½œï¼ˆè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»šï¼‰

---

## å®‰å…¨æ€§ä¿éšœ

### 1. å¤‡ä»½æœºåˆ¶

æ¯æ¬¡ä¿®æ”¹ `state.json` å‰ï¼Œè‡ªåŠ¨åˆ›å»ºå¤‡ä»½ï¼š

```python
timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
backup_file = self.state_file.parent / f"state.backup_{timestamp}.json"
shutil.copy2(self.state_file, backup_file)
```

### 2. åŸå­æ€§æ“ä½œ

å½’æ¡£è¿‡ç¨‹ä¸­å¦‚æœå¤±è´¥ï¼Œä¼šè‡ªåŠ¨å›æ»šåˆ°å¤‡ä»½æ–‡ä»¶ã€‚

### 3. æ•°æ®å®Œæ•´æ€§æ£€æŸ¥

- å½’æ¡£å‰éªŒè¯ JSON æ ¼å¼
- ç¡®ä¿å¿…è¦å­—æ®µå­˜åœ¨ï¼ˆå¦‚ `name`, `importance`ï¼‰

### 4. Windows UTF-8 ç¼–ç ä¿®å¤

```python
if sys.platform == 'win32':
    import io
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')
    sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8')
```

---

## FAQ

### Q1: å½’æ¡£ä¼šä¸¢å¤±æ•°æ®å—ï¼Ÿ

**A**: ä¸ä¼šã€‚æ‰€æœ‰å½’æ¡£æ•°æ®éƒ½ä¿å­˜åœ¨ `archive/` ç›®å½•ï¼Œå¯ä»¥éšæ—¶æ¢å¤ã€‚

---

### Q2: ä¸»è¦è§’è‰²ä¼šè¢«å½’æ¡£å—ï¼Ÿ

**A**: ä¸ä¼šã€‚åªæœ‰ `importance="minor"` çš„æ¬¡è¦è§’è‰²æ‰ä¼šè¢«å½’æ¡£ã€‚ä¸»è¦è§’è‰²ï¼ˆ`importance="major"`ï¼‰æ°¸ä¸å½’æ¡£ã€‚

---

### Q3: å¦‚ä½•æ¢å¤å½’æ¡£çš„è§’è‰²ï¼Ÿ

**A**: ä½¿ç”¨ `python archive_manager.py --restore-character "è§’è‰²å"` å‘½ä»¤ã€‚

---

### Q4: å½’æ¡£ä¼šå½±å“åˆ›ä½œæµç¨‹å—ï¼Ÿ

**A**: ä¸ä¼šã€‚å½’æ¡£æ˜¯åå°è‡ªåŠ¨æ‰§è¡Œçš„ï¼Œä¸é˜»å¡åˆ›ä½œæµç¨‹ã€‚å³ä½¿å½’æ¡£å¤±è´¥ï¼Œä¹Ÿåªä¼šè¾“å‡ºè­¦å‘Šï¼Œä¸ä¼šä¸­æ–­ç« èŠ‚åˆ›ä½œã€‚

---

### Q5: å½’æ¡£é˜ˆå€¼å¯ä»¥è°ƒæ•´å—ï¼Ÿ

**A**: å¯ä»¥ã€‚ç¼–è¾‘ `archive_manager.py` ä¸­çš„ `self.config` å­—å…¸ï¼š

```python
self.config = {
    "character_inactive_threshold": 100,  # æ”¹ä¸º 100 ç« 
    "plot_resolved_threshold": 50,        # æ”¹ä¸º 50 ç« 
    "review_old_threshold": 100,          # æ”¹ä¸º 100 ç« 
}
```

---

### Q6: å¦‚ä½•ç¦ç”¨è‡ªåŠ¨å½’æ¡£ï¼Ÿ

**A**: ä» `webnovel-write.md` çš„ Step 4.5 ä¸­æ³¨é‡Šæ‰å½’æ¡£è°ƒç”¨ï¼š

```markdown
# ç¦ç”¨è‡ªåŠ¨å½’æ¡£ï¼ˆä¸æ¨èï¼Œé™¤éä½ ç¡®å®š state.json ä¸ä¼šè¶…è¿‡ 1MBï¼‰
# python archive_manager.py --auto-check
```

---

## æ€»ç»“

**å½’æ¡£ç³»ç»Ÿçš„æ ¸å¿ƒä»·å€¼**ï¼š

1. âœ… **é˜²æ­¢ state.json æ— é™å¢é•¿**ï¼šç¡®ä¿ 200 ä¸‡å­—é•¿è·‘ç¨³å®š
2. âœ… **æ€§èƒ½ä¼˜åŒ–**ï¼šä¿æŒ `update_state.py` åœ¨ 30-40 ms çš„ç¨³å®šè€—æ—¶
3. âœ… **Git ä»“åº“ä½“ç§¯æ§åˆ¶**ï¼šé¿å…æ¯æ¬¡ commit éƒ½ä¿å­˜å·¨å¤§çš„ state.json
4. âœ… **å¯é€†æ€§**ï¼šæ‰€æœ‰å½’æ¡£æ•°æ®å¯éšæ—¶æ¢å¤
5. âœ… **é€æ˜æ€§**ï¼šç”¨æˆ·å¯ä»¥æŸ¥çœ‹å½’æ¡£ç»Ÿè®¡å’Œé¢„è§ˆå³å°†å½’æ¡£çš„æ•°æ®

**é€‚ç”¨åœºæ™¯**ï¼š
- é•¿ç¯‡ç½‘æ–‡åˆ›ä½œï¼ˆ100 ç« +ï¼‰
- è§’è‰²ä¼—å¤šçš„å²è¯—çº§å°è¯´
- éœ€è¦é•¿æœŸç»´æŠ¤çš„è¿è½½ä½œå“

**Gemini å®¡æ ¸ç»“è®º**ï¼šâœ… ç³»ç»Ÿå·²é€šè¿‡æ‰€æœ‰æµ‹è¯•ï¼Œå¯ä»¥ä¸Šçº¿ã€‚
